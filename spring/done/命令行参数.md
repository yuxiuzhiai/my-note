## æ¦‚å¿µ

å°±ç®—ä¸ç”¨springï¼Œæˆ‘ä»¬è‚¯å®šä¹ŸçŸ¥é“å‘½ä»¤è¡Œå‚æ•°ã€‚å…¶å®å°±ç®—ä½ ä¸ç”¨javaï¼Œä½ ä¹Ÿåº”è¯¥çŸ¥é“å‘½ä»¤è¡Œå‚æ•°ğŸ˜‚

åœ¨å¯åŠ¨ä¸€ä¸ªé€šè¿‡spring bootæ‰“çš„fatjarå½¢å¼çš„Javaç¨‹åºæ—¶ï¼Œæˆ‘ä»¬å¯èƒ½ç”¨å¦‚ä¸‹çš„å‘½ä»¤å»å¯åŠ¨ï¼š

java -Xmx6g -XX:SurvivorRatio=4 -Djava.net.preferIPv4Stack=true --spring.profiles.active=prod -jar study-spring.jar > xx.log

## å¸¸è§ç”¨æ³•

```java
package com.pk.study.spring.env;

import org.apache.logging.log4j.LogManager;
import org.apache.logging.log4j.Logger;
import org.junit.jupiter.api.Test;
import org.springframework.boot.DefaultApplicationArguments;
import org.springframework.core.env.SimpleCommandLinePropertySource;

/**
 * @author pengkai
 * @date 2019/12/9
 */
public class CommandLineArgsTest {
    private static final Logger logger = LogManager.getLogger();
    @Test
    public void test() {
        //æ¨¡æ‹Ÿå¯åŠ¨æ—¶ä¼ å…¥çš„å‘½ä»¤è¡Œå‚æ•°
      	//ä¸€ä¸ªkeyå¯ä»¥æŒ‡å®šå¤šä¸ªå€¼ï¼Œä¸åŒå€¼ç”¨,åˆ†éš”
      	//ä¸€ä¸ªkeyä¹Ÿå¯ä»¥å‡ºç°å¤šæ¬¡ï¼Œä»–çš„å€¼æœ€ç»ˆä¼šè‡ªå·±åˆå¹¶
        String[] args = {"--a", "--b=bb","--c=a,b,c","--c=d", "-Dc=true"};
        //ä½¿ç”¨æ–¹å¼ä¸€:é€šè¿‡ApplicationArgumentsï¼Œè¿™æ˜¯spring bootä¸­æ‰æœ‰çš„
        DefaultApplicationArguments arguments = new DefaultApplicationArguments(args);
        logger.info(arguments.getOptionValues("c"));
        logger.info(arguments.getNonOptionArgs());
        //ä½¿ç”¨æ–¹å¼äºŒï¼šé€šè¿‡PropertySource
        SimpleCommandLinePropertySource ps = new SimpleCommandLinePropertySource(args);
        logger.info(ps.getProperty("b"));
        logger.info(ps.getProperty("c"));
    }
}

```

ApplicationArgumentsæ˜¯spring bootä¸­çš„æ¥å£ï¼Œä½œç”¨å°±æ˜¯ä¿å­˜å¯åŠ¨æ—¶çš„å‘½ä»¤è¡Œå‚æ•°

SimpleCommandLinePropertySourceæ˜¯ä¸€ä¸ªPropertySourceçš„å®ç°ç±»ï¼Œæ˜¯springç”¨äºEnvironmentï¼Œè¡¨ç¤ºæ¥æºäºå‘½ä»¤è¡Œå‚æ•°çš„é…ç½®é¡¹ã€‚å…³äºEnvironmentå’ŒPropertySourceçš„åˆ†æè¯·è§ï¼š[Environmentåˆ†æ](https://blog.csdn.net/yuxiuzhiai/article/details/79427325)

## å®ç°è§£æ

æ— è®ºæ˜¯spring bootä¸­åŸºäºApplicationArgumentsä½¿ç”¨ï¼Œè¿˜æ˜¯Environmentä¸­åŸºäºSimpleCommandLinePropertySourceä½¿ç”¨ã€‚æœ€ç»ˆçš„å…¥å£éƒ½æ˜¯ï¼š

```java
public SimpleCommandLinePropertySource(String... args) {
		super(new SimpleCommandLineArgsParser().parse(args));
}
```

æ‰€ä»¥ä¸»è¦çš„åŠŸèƒ½å°±æ˜¯SimpleCommandLineArgsParser.parse()å‡½æ•°:

```java
public CommandLineArgs parse(String... args) {
		CommandLineArgs commandLineArgs = new CommandLineArgs();
		for (String arg : args) {
			if (arg.startsWith("--")) {
				String optionText = arg.substring(2, arg.length());
				String optionName;
				String optionValue = null;
				if (optionText.contains("=")) {
					optionName = optionText.substring(0, optionText.indexOf('='));
					optionValue = optionText.substring(optionText.indexOf('=')+1, optionText.length());
				}
				else {
					optionName = optionText;
				}
				if (optionName.isEmpty() || (optionValue != null && optionValue.isEmpty())) {
					throw new IllegalArgumentException("Invalid argument syntax: " + arg);
				}
				commandLineArgs.addOptionArg(optionName, optionValue);
			}
			else {
				commandLineArgs.addNonOptionArg(arg);
			}
		}
		return commandLineArgs;
	}
```

å¯ä»¥ï¼Œspring æ ¹æ®å‘½ä»¤è¡Œå‚æ•°æ˜¯å¦æ˜¯--å¼€å¤´ï¼Œå°†å‚æ•°åˆ†ä¸ºä¸¤ç±»ï¼šoptionArgã€nonOptionArg

åœ¨ç»§ç»­çœ‹CommandLineArgsç±»ï¼š

```java
class CommandLineArgs {
	//valueæ˜¯List<String>
	private final Map<String, List<String>> optionArgs = new HashMap<>();
  //å¹¶æ²¡æœ‰å¼„æˆkey valueçš„å½¢å¼
	private final List<String> nonOptionArgs = new ArrayList<>();

  //å¯¹äºoptionArgï¼Œè¿™é‡Œæ˜¯ä¿å­˜æˆäº†Map<String, List<String>>çš„å½¢å¼
	public void addOptionArg(String optionName, @Nullable String optionValue) {
		if (!this.optionArgs.containsKey(optionName)) {
			this.optionArgs.put(optionName, new ArrayList<>());
		}
		if (optionValue != null) {
			this.optionArgs.get(optionName).add(optionValue);
		}
	}
  //ç®€å•çš„å½“æˆå­—ç¬¦ä¸²ä¿ç•™ä¸‹æ¥
	public void addNonOptionArg(String value) {
		this.nonOptionArgs.add(value);
	}

	//å¿½ç•¥ä¸é‡è¦çš„å…¶ä»–æ–¹æ³•
}
```

å¯ä»¥çœ‹åˆ°ï¼Œå¯¹äºoptionArgï¼Œspringä¼šå°†å…¶è§£ææˆé”®å€¼å¯¹çš„å½¢å¼ï¼Œå¹¶ä¸”å€¼æ˜¯List<String>,å¯èƒ½ä½ ä¼šå¥‡æ€ªï¼Œä¸ºå•¥valueæ˜¯ä¸ªListï¼Ÿå› ä¸ºï¼Œspringæ˜¯å…è®¸ä¸€ä¸ªkeyæŒ‡å®šå¤šä¸ªå€¼çš„ï¼Œæ¯”å¦‚ï¼š

--spring.profiles.active=a,b,c

## ç»“è¯­

è¿™ä¸ªéƒ¨åˆ†æ¶‰åŠåˆ°äº†springå’Œspring bootçš„ä»¥ä¸‹ç±»ï¼š

* ApplicationArgumentså’ŒDefaultApplicationArguments
* SimpleCommandLineArgsParserå’ŒCommandLineArgs

å…±è®¡4ä¸ªç±»ã€‚

(æ°´å¹³æœ‰é™ï¼Œæœ€è¿‘åœ¨çœ‹springæºç ï¼Œåˆ†äº«å­¦ä¹ è¿‡ç¨‹ï¼Œå¸Œæœ›å¯¹å„ä½æœ‰ç‚¹å¾®å°çš„å¸®åŠ©ã€‚
å¦‚æœ‰é”™è¯¯ï¼Œè¯·æŒ‡æ­£~)